---
layout: post
categories: 技术
tags: Qemu   
---

参考：虚拟机体验之 QEMU 篇[http://www.cnblogs.com/youxia/p/linux019.html](http://www.cnblogs.com/youxia/p/linux019.html)
## 引言

　　说起虚拟机，大家都不陌生。需要使用虚拟机的场景也非常的多，比如有志于写操作系统的同志，往往需要一个虚拟机来运行和调试他写的系统；再比如喜欢研究网络体系结构的朋友，需要在自己的电脑上虚拟出 N 个系统组成各种各样的网络。（这个需要电脑的配置够强大才行，幸好本人的电脑够。）还比如用 Windows 的想玩 Linux，用 Linux 想玩 Windows，这样用虚拟机玩起来也比较方便；最后比如有人想研究一下目前最流行的大数据啊、云计算啊，想试一试 Hadoop、Spark、OpenStack 什么的，没有虚拟机怎么搭建实验环境。我自己也经常用虚拟机，在 Windows 中用的是 VMWare，感觉它功能强大、使用方便，运行效率也非常的高。我的博客中有不少内容都是在虚拟机中折腾出来的，你们能分得出来吗？在 Linux 系统下，我也用虚拟机。比如在我的这一篇《使用GCC和GNU Binutils编写能在x86实模式运行的16位代码》中，我就使用 QEMU 来运行一个 FreeDOS 系统，用来调试我的 16 位代码。其实我自己也是一个喜欢研究操作系统的主，结识 QEMU 就是从《自己动手写操作系统》这本书开始的。

　　虚拟机的分类很复杂。什么全虚拟、半虚拟什么的搞得人头晕。我用过的虚拟机也不少了，也总是分不清这些概念。而且桌面用户和企业级用户对虚拟机的期望值是不一样的。比如说，我可能期望这样一个虚拟机：

　　

- 1.它能模拟出一台完整的个人电脑，我可以给它安装任何我想安装的操作系统；
- 2.它要有比较好用的图形界面，模拟出的电脑也要能无障碍运行 Windows 或 Gnome 这样的图形系统，能打游戏最好；
- 3.客户操作系统所用的硬盘就是宿主操作系统中的一个镜像文件，随时可复制粘贴，随时可打包带走；
- 4.最好能模拟出一些本身不存在的硬件，比如多个网卡什么的。

　　很显然，VMWare Workstation 就是这样一个可以完美满足我要求的桌面用户最满意的虚拟机。我经常使用它来折腾各个 Linux 发行版，而且运行流畅。当然，在 Linux 这个开源的世界我们是不该去使用破解版这样的东西的。不过不用担心，在 Linux 江湖中，还有 VirtualBox、QEMU 这样的虚拟机软件可用。

###  而企业级用户呢，他们期望的虚拟机可能是这样的：

　　1.它不一定要能模拟出一台完整的电脑，重点是 CPU、内存、磁盘和网卡，重点是能当服务器使用；

　　2.它性能一定要好，虚拟的 CPU 性能一定要接近物理 CPU，一定要充分利用物理 CPU 的所有特性，为了性能，甚至只能安装经过修改过内核的操作系统；（所谓的半虚拟化技术。）

　　3.它隔离性一定要好，它的目的是把一台机器分成 N 台机器用，而管理这 N 台虚拟机的宿主机要越不占用资源越好，客户机是主，宿主机是次；（正如 Xen 这样。）

　　4.由于企业级用户对性能的追求，所以客户机所用的硬盘可能真是一个独立的物理硬盘、磁盘阵列、网络文件系统什么的，而不仅仅只是宿主机上的一个镜像文件；

　　5.它不一定需要有图形界面，因为使用命令行界面更容易管理，比如自动化啊、远程化啊、批量化啊什么的；

　　6.更多的企业级高可用性需求，比如什么热备份啊、动态迁移啊什么的。

　　从上面这些期望值可以看出，虚拟机领域水很深，市场前景也比较广阔。各个虚拟机厂家把自家产品吹得天花乱坠那也是很常见的，因为每一个用户期望的点都可以大做文章嘛。所谓临渊羡鱼，不如退而结网，各种虚拟机看得再过瘾，也不如自己尝试一下。

## QEMU 实战

今天我介绍的是 QEMU。还是老规矩，我的博文并不是该软件的使用手册，所以，它的学习资料还请参考 QEMU 的官网：
	
	　　http://wiki.qemu.org/Main_Page
	
	　　或者，在自己的系统中输入如下命令：
	
	　　man qemu-system-i386
	
	　　man qemu-img
	
	　　等等...

　　QEMU 本身是一个非常强大的虚拟机，甚至在 Xen、KVM 这些虚拟机产品中都少不了 QEMU 的身影。在 QEMU 的官方文档中也提到，QEMU 可以利用 Xen、KVM 等技术来加速。为什么需要加速呢，那是因为如果单纯使用 QEMU 的时候，它自己模拟出了一个完整的个人电脑，它里面的 CPU 啊什么的都是模拟出来的，它甚至可以模拟不同架构的 CPU，比如说在使用 Intel X86 的 CPU 的电脑中模拟出一个 ARM 的电脑或 MIPS 的电脑，这样模拟出的 CPU 的运行速度肯定赶不上物理 CPU。使用加速以后呢，可以把客户操作系统的 CPU 指令直接转发到物理 CPU，自然运行效率大增。

　　QEMU 同时也是一个非常简单的虚拟机，给它一个硬盘镜像就可以启动一个虚拟机，如果想定制这个虚拟机的配置，比如用什么样的 CPU 啊、什么样的显卡啊、什么样的网络配置啊，指定相应的命令行参数就可以了。它支持许多格式的磁盘镜像，包括 VirtualBox 创建的磁盘镜像文件。它同时也提供一个创建和管理磁盘镜像的工具 qemu-img。QEMU 及其工具所使用的命令行参数，直接查看其文档即可。
